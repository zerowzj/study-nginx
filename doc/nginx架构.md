# 一. 介绍

​		Nginx（发音为“engine X”）是由俄罗斯人 Igor Sysoev 编写的一个免费的、开源的、高性能的 HTTP 服务器和反向代理，也是一个电子邮件（IMAP/POP3/SMTP）代理服务器，其特点是占有内存少，并发能力强。Nginx 因为它的稳定性、丰富的模块库、灵活的配置和较低的资源消耗而闻名 。目前 Nginx 已经被 F5 收购。

​		Nginx由内核和一系列模块组成，内核提供web服务的基本功能，如启用网络协议，创建运行环境，接收和分配客户端请求，处理模块之间的交互。Nginx的各种功能和操作都由模块来实现。Nginx的模块从结构上分为核心模块、基础模块和第三方模块。这样的设计使Nginx方便开发和扩展，也正因此才使得Nginx功能如此强大。

# 二. 架构

## 2.1 进程模型

​		Nginx 服务器启动后，产生一个 Master 进程（Master Process），Master 进程执行一系列工作后产生一个或者多个 Worker 进程（Worker Processes)。其中，Master 进程用于接收来自外界的信号，并向各 Worker 进程发送信号，同时监控 Worker 进程的工作状态。当 Worker 进程退出后（异常情况下），Master 进程也会自动重新启动新的 Worker 进程。Worker 进程则是外部请求真正的处理者。

​		多个 Worker 进程之间是对等的，他们同等竞争来自客户端的请求，各进程互相之间是独立的。一个请求，只可能在一个 Worker 进程中处理，一个 Worker 进程不可能处理其它进程的请求。Worker 进程的个数是可以设置的，一般我们会设置与机器 CPU 核数一致。同时，Nginx为了更好的利用多核特性，具有 CPU 绑定选项，我们可以将某一个进程绑定在某一个核上，这样就不会因为进程的切换带来cache的失效（CPU affinity）。所有的进程的都是单线程（即只有一个主线程）的，进程之间通信主要是通过共享内存机制实现的。

> ​		Nginx在启动后，在系统中会以后台模式（daemon）运行，后台进程包含一个 Master 进程和多个 Worker 进程。我们也可以手动地关掉后台模式，让Nginx在前台运行，并且通过配置让 Nginx 取消 Master 进程，从而可以使Nginx以单进程方式运行。很显然，生产环境下我们肯定不会这么做，所以关闭后台模式，一般是用来调试用的。Nginx是以多进程的方式来工作的，当然Nginx也是支持多线程的方式的，只是我们主流的方式还是多进程的方式，也是Nginx的默认方式。Nginx采用多进程的方式有诸多好处，本文主要讲解Nginx的多进程模式。

​		Nginx服务器为了提高对请求的响应效率，进一步降低网络压力，采用了缓存机制，将历史应答数据缓存到本地。在每次Nginx服务器启动后的一段时间内，会启动专门的进程对本地缓存的内容重建索引，保证对缓存文件的快速访问。
​		根据上面的分析，我们可以将Nginx服务器的结构大致分为主进程、工作进程、后端服务器和缓存等部分。

### 2.1.1 服务器进程

​		我们一共提到Nginx服务器的三大类进程：一类是主进程，另一类是由主进程生成的工作进程，还有刚才提到的用于为缓存文件建立索引的进程。

1. 主进程（Master Process）

   ​		Nginx服务器启动时运行的主要进程。它的主要功能是与外界通信和对内部其他进程进行管理，具体来说有以下几点：

   - 读取Nginx配置文件并验证其有效性和正确性
   - 建立、绑定和关闭Socket
   - 按照配置生成、管理和结束工作进程
   - 接收外界指令，比如重启、升级及退出服务器等指令
   - 不中断服务，实现平滑重启，应用新配置
   - 不中断服务，实现平滑升级，升级失败进行回滚处理
   - 开启日志文件，获取文件描述符
   - 编译和处理Perl脚本。

2. 工作进程（Worker Process）

   ​		由主进程生成，生成数量可以通过Nginx配置文件指定，正常情况下生存于主进程的整个生命周期。该进程的主要工作有以下几项：

   - 接受客户端请求
   - 将请求一次送入各个功能模块进行过滤处理
   - IO调用，获取响应数据
   - 与后端服务器通信，接收后端服务器处理结果
   - 数据缓存，访问缓存索引、查询和调用缓存数据
   - 发送请求结果，响应客户端请求
   - 接收主程序指令，比如重启、升级和退出等指令

   ​		工作进程完成的工作还有很多，我们在这里列出了主要的几项。从这些工作中可以看到，该进程是Nginx服务器提供Web服务、处理客户端请求的主要进程，完成了Nginx服务器的主题工作。因此，在实际使用中，作为服务器管理者，我们应该重点监视工作进程的运行状态，保证Nginx服务器对外提供稳定的Web服务。

3. 缓存索引重建及管理进程

   ​		Cache模块，主要由缓存索引重建（Cache Loader)和缓存索引管理（Cache Manager）两类进程完成工作。缓存索引重建进程是在Nginx服务启动一段时间后（默认是1分钟）由主进程生成，在缓存元数据重建完成后就自动退出。缓存索引管理进程一般存在于主进程的整个生命周期，负责对缓存索引进行管理。
   ​		缓存索引重建进程完成的主要工作是，根据本地磁盘上的缓存文件在内存中建立索引元数据库。该进程启动后，对本地磁盘上存放缓存文件的目录结构进行扫描，检查内存中已有的缓存元数据是否正确，并更新索引元数据库。
   ​		缓存索引管理进程主要负责在索引元数据更新完成后，对元数据是否过期做出判断。
   ​		这两个进程维护的内存索引元数据库，为工作进程对缓存数据的快速查询提供了便利。

   

### 2.1.2 进程交互

​		Nginx服务器在使用Master-Worker模型时，会涉及主进程与工作进程（Master-Worker）之间的交互和工作进程（Worker-Worker）之间的交互。这两类交互都依赖于管道（channel）机制，交互的准备工作都是在工作进程生成时完成的。

1. Master-Worker交互

   ​		工作进程是由主进程生成的（使用了fork函数）。Nginx服务器启动以后，主进程根据配置文件决定生成的工作进程的数量，然后建立一张全局的工作进程表用于存放当前未退出的所有工作进程。

   ​		在主进程生成工作进程后，将新生成的工作进程加入到工作进程表中，并建立一个单向管道并将其传递给该工作进程。该管道与普通的管道不同，它是由主进程指向工作进程的单向管道，包含了主进程向工作进程发出的指令、工作进程ID、工作进程在工作进程表中的索引和必要的文件描述符等信息。

   ​		主进程与外界通过信号机制进行通信，当接收到需要处理的信号时，它通过管道向相关的工作进程发送正确的指令。每个工作进程都有能力捕获管道中可读事件，当管道中有可读事件时，工作进程从管道读取并解析指令，然后采用响应的措施。这样就完成了Master-Worker的交互。

2. Worker-Worker交互

   ​		Worker-Worker交互在实现原理上和Master-Worker交互基本是一样的。主要工作进程之间能够得到彼此的信息，建立管道，即可通信。由于工作进程之间是相互隔离的，因此一个进程要想知道另一个进程的信息，只能通过主进程来设置了。
    		为了达到工作进程之间交互的目的，主进程在生成工作进程后，在工作进程表中进行遍历，将该新进程的ID以及针对该进程建立的管道句柄传递给工作进程表中的其他进程，为工作进程之间的交互做准备。每个工作进程捕获管道中可读事件，根据指令采取相应的措施。这样就完成了Worker-Worker交互。

   

   

   

   

   

## 2.2 模块化

​		Nginx 的内部结构是由内核和一系列的功能模块所组成，高度模块化的设计是 Nginx 的架构基础。内核的设计非常微小和简洁，完成的工作也非常简单。Nginx的各种功能和操作都由模块来实现，每个模块就是一个功能模块，只负责自身的功能，模块之间严格遵循“高内聚，低耦合”的原则。

​		Nginx模块分为核心模块、基础模块和第三方模块。

1. 核心模块

   HTTP模块、EVENT模块(事件)、MAIL模块

2. 基础模块

   HTTP Access模块、HTTP FastCGI模块、HTTP Proxy模块、HTTP Rewrite模块

3. 第三方模块

   HTTP Upstream Request Hash模块、Notice模块、HTTP Access Key模块

​		模块从功能上还可以分为以下几种：

1. Handlers（处理器模块）

   此类模块直接处理请求，并进行输出内容和修改 headers 信息等操作。Handlers 处理器模块一般只能有一个。

2. Filters（过滤器模块）

   此类模块主要对其他处理器模块输出的内容进行修改操作，最后由 Nginx 输出。

3. Proxies（代理类模块）

   此类模块是 Nginx 的 HTTP Upstream 之类的模块，这些模块主要与后端一些服务比如FastCGI 等进行交互，实现服务代理和负载均衡等功能。







# 三. 常用使用场景







# 三. Nginx工作原理

​		Nginx由内核和模块组成，完成工作是通过查找配置文件将客户端请求映射到一个location block（location是用于URL匹配的命令），location配置的命令会启动不同模块完成工作。

